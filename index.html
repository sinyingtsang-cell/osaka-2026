<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tabi Note Pro Max ğŸŒ¸ çµ‚æ¥µå…¨èƒ½ç‰ˆ</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuedraggable@4.1.0/dist/vuedraggable.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --sakura: #5C9E97; }
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        #app { height: 100%; display: flex; flex-direction: column; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; align-items: center; height: 75px; padding-bottom: env(safe-area-inset-bottom); z-index: 9999; }
        .dark .bottom-nav { background: rgba(20,20,20,0.95); border-color: #334155; }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; cursor: pointer; color: #94a3b8; transition: 0.2s; }
        .tab-item.active { color: var(--sakura); font-weight: bold; transform: translateY(-2px); }

        .content-area { flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .wander-card { background: white; border-radius: 20px; border: 1px solid #f1f5f9; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        .dark .wander-card { background: #1e293b; border-color: #334155; color: white; }
        .dark body { background-color: #0f172a; color: white; }

        input, select, textarea { width: 100%; padding: 12px; border-radius: 12px; background: #f1f5f9; border: none; outline: none; font-size: 14px; }
        .dark input, .dark select, .dark textarea { background: #0f172a; border: 1px solid #334155; color: white; }
        
        .drag-handle { cursor: grab; }
        .drag-ghost { opacity: 0.5; background: #f0fdfa !important; border: 2px dashed var(--sakura) !important; }
        .leaflet-path-route { stroke-dasharray: 10, 15; animation: dash 30s linear infinite; }
        @keyframes dash { to { stroke-dashoffset: -1000; } }
    </style>
</head>
<body :class="{'dark': isDarkMode}">

<div id="app" class="max-w-md mx-auto relative bg-inherit">
    
    <header class="px-6 pt-12 pb-4 bg-white dark:bg-slate-900 border-b dark:border-slate-800 flex justify-between items-end">
        <div @click="isDarkMode = !isDarkMode">
            <h1 class="text-xl font-black uppercase tracking-tighter flex items-center gap-2">
                {{ tripName || 'Tabi Note' }}
                <i :class="isDarkMode ? 'fa-solid fa-moon text-indigo-400' : 'fa-solid fa-sun text-orange-400'" class="text-xs"></i>
            </h1>
            <p class="text-[9px] font-bold text-slate-400"><i class="fa-solid fa-cloud-arrow-up text-green-500 mr-1 animate-pulse"></i> å¤šäººå³æ™‚åŒæ­¥ä¸­</p>
        </div>
        <button @click="copyShareLink" class="bg-[#5C9E97] text-white text-[10px] font-bold px-4 py-2 rounded-full shadow-lg">åˆ†äº«å…±ç·¨</button>
    </header>

    <main class="content-area no-scrollbar px-6 pt-4">
        
        <div v-if="!tripId" class="py-12 space-y-8 text-center animate-fade-in">
            <h2 class="text-3xl font-black tracking-tighter">é–‹å§‹è¦åŠƒä½ çš„<br><span class="text-[#5C9E97]">æ—¥æœ¬è‡ªé§•è¡Œç¨‹</span></h2>
            <div class="space-y-4">
                <input v-model="tempTripName" type="text" placeholder="ç›®çš„åœ° (å¦‚: å¤§é˜ª)" class="font-bold text-center">
                <div class="grid grid-cols-2 gap-4">
                    <input v-model="tempStartDate" type="date" class="text-xs">
                    <input v-model="tempEndDate" type="date" class="text-xs">
                </div>
                <button @click="createNewTrip" class="w-full bg-[#5C9E97] text-white py-4 rounded-2xl font-black text-lg">å»ºç«‹ PWA è¡Œç¨‹</button>
            </div>
        </div>

        <template v-else>
            <div v-show="activeTab === 'plan'" class="space-y-6">
                <div class="flex overflow-x-auto no-scrollbar gap-3 pb-2">
                    <button v-for="day in travelDays" :key="day.date" @click="selectedDate = day.date"
                        class="flex-col items-center justify-center flex-shrink-0 w-16 h-20 rounded-2xl transition-all relative"
                        :class="selectedDate === day.date ? 'bg-[#5C9E97] text-white shadow-lg' : 'bg-slate-100 dark:bg-slate-800 text-slate-400'">
                        <span class="text-[8px] font-bold">{{ day.weekday }}</span>
                        <span class="text-base font-black">{{ day.dayNum }}</span>
                        <div v-if="dailyWeather[day.date]" class="text-[9px] mt-1 font-bold">
                            {{ dailyWeather[day.date].icon }} {{ dailyWeather[day.date].min }}Â°
                        </div>
                    </button>
                </div>

                <div v-for="f in flightsForSelectedDate" :key="'f'+f.id" class="wander-card p-4 bg-blue-50 dark:bg-slate-800 border-blue-200 dark:border-slate-700">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-plane-departure text-blue-400 text-xl"></i>
                        <div>
                            <div class="text-[10px] font-bold text-blue-500 uppercase">{{ f.depTime }} - {{ f.arrTime }}</div>
                            <div class="font-black text-sm">{{ f.airline }} {{ f.flightNo }}</div>
                            <div class="text-[10px] text-slate-500">{{ f.depAirport }} â” {{ f.arrAirport }}</div>
                        </div>
                    </div>
                </div>

                <div v-for="h in checkOutHotels" :key="'hout'+h.id" class="wander-card p-3 bg-orange-50 dark:bg-slate-800 border-orange-200">
                    <div class="text-xs font-bold text-orange-600"><i class="fa-solid fa-hotel mr-1"></i> é€€æˆ¿ (11:00 å‰): {{ h.name }}</div>
                </div>

                <draggable v-model="itineraries[selectedDate]" item-key="id" handle=".drag-handle" ghost-class="drag-ghost" @end="syncToCloud" class="space-y-4">
                    <template #item="{element}">
                        <div class="wander-card p-5 space-y-2 relative group">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-grip-vertical text-slate-300 drag-handle text-lg px-1"></i>
                                    <span class="text-[10px] font-bold text-slate-400">{{ element.time }} | {{ element.type }}</span>
                                </div>
                            </div>
                            <h4 class="font-bold text-base pr-6">{{ element.place }}</h4>
                            
                            <div class="flex gap-2 pt-1">
                                <button v-if="element.mapCode" @click="openGoogleMaps(element.mapCode)" class="bg-[#5C9E97] text-white text-[9px] font-bold px-3 py-1 rounded-full shadow-sm active:scale-95 transition">
                                    <i class="fa-solid fa-location-arrow mr-1"></i>MapCode: {{ element.mapCode }}
                                </button>
                                <button v-else @click="openGoogleMaps(element.place)" class="bg-slate-100 dark:bg-slate-700 text-[#5C9E97] text-[9px] font-bold px-3 py-1 rounded-full shadow-sm active:scale-95 transition">
                                    <i class="fa-solid fa-diamond-turn-right mr-1"></i>å°èˆª
                                </button>
                            </div>

                            <button @click="deleteItem(element.id)" class="absolute top-4 right-4 text-slate-200 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </template>
                </draggable>

                <div v-for="h in checkInHotels" :key="'hin'+h.id" class="wander-card p-4 bg-orange-50 dark:bg-slate-800 border-orange-200">
                    <div class="flex items-start gap-3">
                        <i class="fa-solid fa-bed text-orange-400 text-xl mt-1"></i>
                        <div class="flex-1">
                            <div class="text-[10px] font-bold text-orange-500 uppercase">15:00 å¾Œç™»è¨˜å…¥ä½</div>
                            <div class="font-black text-sm">{{ h.name }}</div>
                            <div class="text-[9px] text-slate-500 mt-1">é ç´„è™Ÿ: {{ h.ref }}</div>
                        </div>
                        <button @click="openGoogleMaps(h.address)" class="bg-orange-400 text-white text-[9px] font-bold px-3 py-1.5 rounded-full"><i class="fa-solid fa-location-arrow"></i></button>
                    </div>
                </div>

                <button @click="showAddModal = true" class="w-full py-5 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-[24px] text-slate-400 font-bold uppercase text-[10px]">+ æ–°å¢æ™¯é»</button>
            </div>

            <div v-show="activeTab === 'map'" class="h-full flex flex-col space-y-4">
                <div class="flex justify-between items-center px-1">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Day {{ travelDays.find(d=>d.date===selectedDate)?.dayNum }} Route</h3>
                    <button @click="updateMapMarkers" class="text-[#5C9E97] text-[10px] font-bold bg-teal-50 dark:bg-slate-800 px-3 py-1 rounded-full"><i class="fa-solid fa-rotate-right mr-1"></i>åˆ·æ–°è·¯ç·š</button>
                </div>
                <div id="map-container" class="w-full rounded-[24px] border dark:border-slate-800 overflow-hidden min-h-[450px] shadow-inner relative z-0"></div>
            </div>

            <div v-show="activeTab === 'info'" class="space-y-6">
                
                <div class="space-y-3">
                    <div class="flex justify-between items-center"><h3 class="text-xs font-black text-[#5C9E97] uppercase tracking-widest"><i class="fa-solid fa-plane mr-1"></i>èˆªç­è¨˜éŒ„</h3></div>
                    <div v-for="f in flights" :key="f.id" class="wander-card p-4 border-l-4 border-blue-400 relative">
                        <button @click="deleteFlight(f.id)" class="absolute top-2 right-2 text-slate-200"><i class="fa-solid fa-trash-can"></i></button>
                        <div class="text-[10px] font-bold text-slate-400 mb-1">æ—¥æœŸ: {{ f.date }}</div>
                        <div class="font-black">{{ f.airline }} {{ f.flightNo }}</div>
                        <div class="flex justify-between text-xs mt-2"><span>{{ f.depAirport }} ({{ f.depTime }})</span> â” <span>{{ f.arrAirport }} ({{ f.arrTime }})</span></div>
                    </div>
                    <button @click="showAddFlightModal = true" class="w-full py-3 bg-slate-100 dark:bg-slate-800 rounded-xl text-[10px] font-bold text-slate-400">+ åŠ å…¥èˆªç­</button>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between items-center"><h3 class="text-xs font-black text-orange-400 uppercase tracking-widest"><i class="fa-solid fa-hotel mr-1"></i>ä½å®¿è¨˜éŒ„</h3></div>
                    <div v-for="h in hotels" :key="h.id" class="wander-card p-4 border-l-4 border-orange-400 relative">
                        <button @click="deleteHotel(h.id)" class="absolute top-2 right-2 text-slate-200"><i class="fa-solid fa-trash-can"></i></button>
                        <h4 class="font-black text-sm pr-6">{{ h.name }}</h4>
                        <div class="text-[10px] font-bold text-slate-400 mt-1">In: {{ h.checkInDate }} | Out: {{ h.checkOutDate }}</div>
                        <div class="text-[10px] font-bold text-slate-400 mt-1 truncate">åœ°å€: {{ h.address }}</div>
                    </div>
                    <button @click="showAddHotelModal = true" class="w-full py-3 bg-slate-100 dark:bg-slate-800 rounded-xl text-[10px] font-bold text-slate-400">+ åŠ å…¥é…’åº—</button>
                </div>
            </div>

            <div v-show="activeTab === 'memo'" class="space-y-8 pb-10">
                <h2 class="text-2xl font-black uppercase">å‚™å¿˜éŒ„</h2>
                <div v-for="listType in ['packing','medicine']" class="wander-card p-5 space-y-3">
                    <h3 class="text-[10px] font-black uppercase text-[#5C9E97] tracking-widest">{{ listType === 'packing' ? 'è¡Œææ¸…å–®' : 'è—¥ç‰©æ¸…å–®' }}</h3>
                    <div class="flex gap-2"><input v-model="newItemInput[listType]" @keyup.enter="addListItem(listType)" placeholder="æ–°å¢..." class="text-sm"><button @click="addListItem(listType)" class="bg-[#5C9E97] text-white px-4 rounded-xl font-bold">åŠ </button></div>
                    <div class="space-y-1"><div v-for="item in (listType === 'packing' ? packingList : medicineList)" :key="item.id" @click="toggleListItem(listType, item.id)" class="flex justify-between p-3 rounded-lg bg-slate-50 dark:bg-slate-800 cursor-pointer" :class="{'opacity-40 line-through': item.done}"><span class="text-xs font-bold">{{ item.text }}</span><button @click.stop="deleteListItem(listType, item.id)"><i class="fa-solid fa-xmark"></i></button></div></div>
                </div>
                <div class="wander-card p-5 space-y-4">
                    <h3 class="text-[10px] font-black uppercase text-red-400 tracking-widest"><i class="fa-solid fa-file-pdf mr-1"></i> é‡è¦æ–‡ä»¶ (PDF)</h3>
                    <input type="file" @change="handleFileUpload($event, 'pdf')" accept="application/pdf" class="text-xs">
                    <div v-for="(pdf, idx) in pdfFiles" :key="idx" class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800 rounded-xl">
                        <span class="text-[10px] font-bold truncate pr-4">{{ pdf.name }}</span>
                        <div class="flex gap-2">
                            <button @click="viewPdf(pdf.data)" class="text-red-500 text-[10px] font-black">æŸ¥çœ‹</button>
                            <button @click="deleteFile(idx, 'pdf')" class="text-slate-300"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="activeTab === 'pay'" class="space-y-6">
                <div class="wander-card p-5 bg-[#5C9E97] text-white shadow-lg">
                    <div class="flex justify-between items-center text-[10px] font-black uppercase"><span>Converter</span><span>Rate: {{ exchangeRate.toFixed(4) }}</span></div>
                    <div class="flex items-center gap-3 mt-3">
                        <input v-model.number="fx.jpy" @input="convertFX('jpy')" type="number" placeholder="JPY" class="w-1/2 bg-white/20 text-white font-black text-lg border-0 placeholder-white/40">
                        <i class="fa-solid fa-right-left opacity-50"></i>
                        <input v-model.number="fx.hkd" @input="convertFX('hkd')" type="number" placeholder="HKD" class="w-1/2 bg-white/20 text-white font-black text-lg border-0 placeholder-white/40">
                    </div>
                </div>
                
                <div class="wander-card p-5 space-y-3">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">æˆå“¡</h3>
                    <div class="flex flex-wrap gap-2">
                        <span v-for="m in members" :key="m" class="bg-slate-100 dark:bg-slate-800 px-3 py-1.5 rounded-full text-xs font-bold">{{ m }} <button @click="removeMember(m)"><i class="fa-solid fa-xmark"></i></button></span>
                    </div>
                    <div class="flex gap-2"><input v-model="newMember" placeholder="æ–°å¢æˆå“¡" class="text-sm"><button @click="addMember" class="bg-slate-800 text-white px-4 rounded-xl text-xs font-bold">åŠ å…¥</button></div>
                </div>

                <div v-if="calculateSettlements.length > 0" class="wander-card p-5 space-y-4 bg-teal-50 dark:bg-slate-800 border-teal-200">
                    <h3 class="text-[10px] font-black text-[#5C9E97] uppercase tracking-widest">çµç®—æ¸…å–®</h3>
                    <div v-for="s in calculateSettlements" :key="s.from + s.to" class="flex justify-between items-center bg-white dark:bg-slate-700 p-4 rounded-xl">
                        <div class="font-bold text-sm"><span class="text-red-500">{{ s.from }}</span> â” <span class="text-green-600">{{ s.to }}</span></div>
                        <div class="text-right"><div class="font-black text-lg">Â¥ {{ Math.round(s.amount).toLocaleString() }}</div></div>
                    </div>
                </div>

                <div class="wander-card p-5 space-y-3">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">è¨˜å¸³</h3>
                    <div class="flex gap-2"><input v-model="newExp.item" placeholder="é …ç›®" class="flex-1 text-sm"><select v-model="newExp.payer" class="w-1/3 text-xs"><option v-for="m in members" :value="m">{{m}} ä»˜</option></select></div>
                    <div class="flex gap-2"><input v-model.number="newExp.amount" placeholder="Â¥" type="number" class="flex-1 text-sm"><button @click="addExp" class="bg-slate-800 text-white px-5 rounded-xl font-bold text-xs uppercase">æ–°å¢</button></div>
                </div>
            </div>
        </template>
    </main>

    <nav v-if="tripId" class="bottom-nav">
        <div v-for="tab in [{i:'calendar-alt',l:'Plan',v:'plan'},{i:'map-location-dot',l:'Map',v:'map'},{i:'plane',l:'Info',v:'info'},{i:'note-sticky',l:'Memo',v:'memo'},{i:'hand-holding-dollar',l:'Pay',v:'pay'}]" 
            :key="tab.v" @click="activeTab = tab.v" :class="['tab-item', { 'active': activeTab === tab.v }]">
            <i :class="['fa-solid', 'fa-'+tab.i, 'text-xl']"></i>
            <span class="text-[8px] mt-1 uppercase font-black">{{tab.l}}</span>
        </div>
    </nav>

    <div v-if="showAddModal" class="fixed inset-0 z-[10000] bg-black/80 flex items-end">
        <div class="bg-white dark:bg-slate-900 w-full rounded-t-[32px] p-8 space-y-4 pb-12 shadow-2xl">
            <div class="flex justify-between items-center mb-2"><h2 class="text-xl font-black">æ–°å¢æ™¯é»</h2><button @click="showAddModal=false" class="text-slate-400 text-xl"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="grid grid-cols-2 gap-2"><input v-model="newItem.time" type="time" class="font-bold"><select v-model="newItem.type" class="font-bold text-xs"><option v-for="t in ['Spot','Food','Shopping']" :value="t">{{t}}</option></select></div>
            <input v-model="newItem.place" placeholder="åœ°é»åç¨±" class="font-bold text-lg">
            <input v-model="newItem.mapCode" placeholder="MapCode (é¸å¡«)" class="font-mono text-sm">
            <button @click="saveItem" class="w-full bg-[#5C9E97] text-white py-4 rounded-2xl font-black text-lg mt-2">ç¢ºèªå„²å­˜</button>
        </div>
    </div>

    <div v-if="showAddFlightModal" class="fixed inset-0 z-[10000] bg-black/80 flex items-end">
        <div class="bg-white dark:bg-slate-900 w-full rounded-t-[32px] p-8 space-y-4 pb-12 shadow-2xl">
            <div class="flex justify-between items-center mb-2"><h2 class="text-xl font-black">æ–°å¢èˆªç­</h2><button @click="showAddFlightModal=false" class="text-slate-400"><i class="fa-solid fa-xmark"></i></button></div>
            <input v-model="newFlight.date" type="date" class="w-full">
            <div class="grid grid-cols-2 gap-2"><input v-model="newFlight.airline" placeholder="èˆªç©ºå…¬å¸"><input v-model="newFlight.flightNo" placeholder="èˆªç­è™Ÿ"></div>
            <div class="grid grid-cols-2 gap-2"><input v-model="newFlight.depAirport" placeholder="èµ·é£›åœ° (HKG)"><input v-model="newFlight.depTime" type="time"></div>
            <div class="grid grid-cols-2 gap-2"><input v-model="newFlight.arrAirport" placeholder="é™è½åœ° (KIX)"><input v-model="newFlight.arrTime" type="time"></div>
            <button @click="saveFlight" class="w-full bg-blue-500 text-white py-4 rounded-2xl font-black text-lg">åŠ å…¥èˆªç­</button>
        </div>
    </div>

    <div v-if="showAddHotelModal" class="fixed inset-0 z-[10000] bg-black/80 flex items-end">
        <div class="bg-white dark:bg-slate-900 w-full rounded-t-[32px] p-8 space-y-4 pb-12 shadow-2xl">
            <div class="flex justify-between items-center mb-2"><h2 class="text-xl font-black">æ–°å¢ä½å®¿</h2><button @click="showAddHotelModal=false" class="text-slate-400"><i class="fa-solid fa-xmark"></i></button></div>
            <input v-model="newHotel.name" placeholder="é…’åº—åç¨±" class="font-bold">
            <div class="grid grid-cols-2 gap-2"><input v-model="newHotel.checkInDate" type="date" title="å…¥ä½æ—¥"><input v-model="newHotel.checkOutDate" type="date" title="é€€æˆ¿æ—¥"></div>
            <input v-model="newHotel.address" placeholder="åœ°å€ (ä¾›å°èˆªç”¨)">
            <input v-model="newHotel.ref" placeholder="é ç´„è™Ÿç¢¼">
            <button @click="saveHotel" class="w-full bg-orange-400 text-white py-4 rounded-2xl font-black text-lg">åŠ å…¥ä½å®¿</button>
        </div>
    </div>

</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB9wFH5e6STNJZpIRqaUtQeXjVvwQYfC0g",
        authDomain: "osaka-trip-2026-fdf24.firebaseapp.com",
        projectId: "osaka-trip-2026-fdf24",
        storageBucket: "osaka-trip-2026-fdf24.firebasestorage.app",
        messagingSenderId: "664640134307",
        appId: "1:664640134307:web:22b0ec1d2af2b292273316"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const { createApp } = Vue;
    const { draggable } = window.vuedraggable;

    createApp({
        components: { draggable },
        data() {
            return {
                isDarkMode: false, tripId: new URLSearchParams(window.location.search).get('trip'),
                tripName: '', startDate: '', endDate: '', tempTripName: '', tempStartDate: '', tempEndDate: '',
                activeTab: 'plan', selectedDate: '', travelDays: [], itineraries: {}, 
                flights: [], hotels: [], packingList: [], medicineList: [], pdfFiles: [], photoNotes: [],
                newItemInput: { packing: '', medicine: '' }, 
                showAddModal: false, showAddFlightModal: false, showAddHotelModal: false,
                newItem: { time: '10:00', place: '', mapCode: '', type: 'Spot' },
                newFlight: { date: '', airline: '', flightNo: '', depAirport: '', depTime: '', arrAirport: '', arrTime: '' },
                newHotel: { name: '', checkInDate: '', checkOutDate: '', address: '', ref: '' },
                exchangeRate: 0.051, fx: { jpy: null, hkd: null }, mapInstance: null, mapMarkers: [], mapRoute: null,
                members: ['æˆ‘', 'æ—…ä¼´A'], newMember: '', expenses: [], newExp: { item: '', amount: null, payer: '' },
                geoCache: {}, dailyWeather: {} // æ–°å¢å¤©æ°£èˆ‡åœ°åœ–å¿«å–
            }
        },
        computed: {
            flightsForSelectedDate() { return this.flights.filter(f => f.date === this.selectedDate); },
            checkInHotels() { return this.hotels.filter(h => h.checkInDate === this.selectedDate); },
            checkOutHotels() { return this.hotels.filter(h => h.checkOutDate === this.selectedDate); },
            
            calculateSettlements() {
                if (!this.expenses.length || !this.members.length) return [];
                let balances = {}; this.members.forEach(m => balances[m] = 0);
                let total = 0;
                this.expenses.forEach(e => { if(balances[e.payer] !== undefined) { balances[e.payer] += e.amount; total += e.amount; } });
                let perPerson = total / this.members.length;
                let debtors = [], creditors = [];
                this.members.forEach(m => {
                    let b = balances[m] - perPerson;
                    if (b < -0.1) debtors.push({ name: m, amount: Math.abs(b) }); else if (b > 0.1) creditors.push({ name: m, amount: b });
                });
                debtors.sort((a, b) => b.amount - a.amount); creditors.sort((a, b) => b.amount - a.amount);
                let settlements = [], i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    let d = debtors[i], c = creditors[j], amt = Math.min(d.amount, c.amount);
                    settlements.push({ from: d.name, to: c.name, amount: amt });
                    d.amount -= amt; c.amount -= amt;
                    if (d.amount < 0.1) i++; if (c.amount < 0.1) j++;
                }
                return settlements;
            }
        },
        watch: {
            activeTab(tab) {
                if (tab === 'map') {
                    this.$nextTick(() => { 
                        this.initMap(); 
                        setTimeout(() => { 
                            if(this.mapInstance) { this.mapInstance.invalidateSize(); this.updateMapMarkers(); }
                        }, 400); 
                    });
                }
            },
            selectedDate() { if (this.activeTab === 'map') this.updateMapMarkers(); }
        },
        methods: {
            // == API: ç²å–å¤©æ°£ (Open-Meteo) ==
            async fetchWeather() {
                if(!this.tripName) return;
                try {
                    const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(this.tripName)}&limit=1`);
                    const geoData = await geoRes.json();
                    if(geoData[0]) {
                        const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${geoData[0].lat}&longitude=${geoData[0].lon}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`);
                        const wData = await wRes.json();
                        const wMap = {};
                        const wIcons = { 0:'â˜€ï¸', 1:'ğŸŒ¤ï¸', 2:'â›…', 3:'â˜ï¸', 45:'ğŸŒ«ï¸', 51:'ğŸŒ§ï¸', 61:'ğŸŒ§ï¸', 71:'â„ï¸', 80:'ğŸŒ§ï¸', 95:'â›ˆï¸' };
                        wData.daily.time.forEach((d, i) => {
                            let code = wData.daily.weather_code[i];
                            wMap[d] = { max: Math.round(wData.daily.temperature_2m_max[i]), min: Math.round(wData.daily.temperature_2m_min[i]), icon: wIcons[code] || 'â˜ï¸' };
                        });
                        this.dailyWeather = wMap;
                    }
                } catch(e) { console.log("Weather error", e); }
            },

            // == API: åœ°åœ–æ¨™è¨˜ ==
            initMap() {
                if (this.mapInstance) this.mapInstance.remove();
                this.mapInstance = L.map('map-container', { zoomControl: false }).setView([34.69, 135.50], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.mapInstance);
            },
            async updateMapMarkers() {
                if(!this.mapInstance) return; 
                this.mapMarkers.forEach(m => this.mapInstance.removeLayer(m));
                if(this.mapRoute) this.mapInstance.removeLayer(this.mapRoute);
                this.mapMarkers = []; let pts = [];

                const items = this.itineraries[this.selectedDate] || [];
                if(items.length === 0) return;

                for(let i of items) {
                    if(!this.geoCache[i.place]) {
                        await new Promise(r => setTimeout(r, 400)); // é¿å… API é™åˆ¶
                        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(i.place + ' ' + this.tripName)}&limit=1`).catch(()=>null);
                        if(r) { const d = await r.json(); if(d[0]) this.geoCache[i.place] = [parseFloat(d[0].lat), parseFloat(d[0].lon)]; }
                    }
                    const loc = this.geoCache[i.place];
                    if(loc) {
                        const mk = L.marker(loc).addTo(this.mapInstance).bindPopup(`<b>${i.time}</b><br>${i.place}`);
                        this.mapMarkers.push(mk); pts.push(loc); 
                    }
                }
                if(pts.length > 1) {
                    this.mapRoute = L.polyline(pts, { color: '#5C9E97', weight: 4, className: 'leaflet-path-route' }).addTo(this.mapInstance);
                    this.mapInstance.fitBounds(this.mapRoute.getBounds(), { padding: [40, 40] });
                } else if(pts.length === 1) {
                    this.mapInstance.setView(pts[0], 14);
                }
            },
            
            // == å°èˆª (Google Maps) ==
            openGoogleMaps(query) {
                // å®Œç¾è·³è½‰ Google Maps
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
            },

            // == æ—…ç¨‹èˆ‡å…±ç·¨ ==
            createNewTrip() {
                if(!this.tempTripName) return alert("è«‹è¼¸å…¥ç›®çš„åœ°");
                const id = 'trip_' + Math.random().toString(36).substr(2, 9);
                window.location.search = `?trip=${id}&name=${encodeURIComponent(this.tempTripName)}&start=${this.tempStartDate}&end=${this.tempEndDate}`;
            },
            copyShareLink() { navigator.clipboard.writeText(window.location.href); alert("å…±ç·¨é€£çµå·²è¤‡è£½ï¼"); },
            syncToCloud() {
                if (!this.tripId) return;
                db.collection('tabi_sync_v14').doc(this.tripId).set({
                    tripName: this.tripName, startDate: this.startDate, endDate: this.endDate,
                    itineraries: this.itineraries, flights: this.flights, hotels: this.hotels,
                    packingList: this.packingList, medicineList: this.medicineList, pdfFiles: this.pdfFiles,
                    members: this.members, expenses: this.expenses
                }, { merge: true });
            },

            // == CRUD: è¡Œç¨‹/èˆªç­/é…’åº— ==
            saveItem() {
                if(!this.newItem.place) return;
                if(!this.itineraries[this.selectedDate]) this.itineraries[this.selectedDate] = [];
                this.itineraries[this.selectedDate].push({ id: Date.now(), ...this.newItem });
                this.showAddModal = false; this.newItem.place = ''; this.newItem.mapCode = '';
                this.syncToCloud();
            },
            deleteItem(id) { this.itineraries[this.selectedDate] = this.itineraries[this.selectedDate].filter(i => i.id !== id); this.syncToCloud(); },
            saveFlight() { this.flights.push({ id: Date.now(), ...this.newFlight }); this.showAddFlightModal = false; this.syncToCloud(); },
            deleteFlight(id) { this.flights = this.flights.filter(f => f.id !== id); this.syncToCloud(); },
            saveHotel() { this.hotels.push({ id: Date.now(), ...this.newHotel }); this.showAddHotelModal = false; this.syncToCloud(); },
            deleteHotel(id) { this.hotels = this.hotels.filter(h => h.id !== id); this.syncToCloud(); },

            // == æ¸…å–®èˆ‡æª”æ¡ˆ ==
            addListItem(type) { if(!this.newItemInput[type]) return; const l = type === 'packing' ? this.packingList : this.medicineList; l.unshift({id: Date.now(), text: this.newItemInput[type], done: false}); this.newItemInput[type] = ''; this.syncToCloud(); },
            toggleListItem(type, id) { const l = type === 'packing' ? this.packingList : this.medicineList; const i = l.find(x => x.id === id); if(i) i.done = !i.done; this.syncToCloud(); },
            deleteListItem(type, id) { if(type === 'packing') this.packingList = this.packingList.filter(x => x.id !== id); else this.medicineList = this.medicineList.filter(x => x.id !== id); this.syncToCloud(); },
            handleFileUpload(e, type) {
                const file = e.target.files[0]; if (!file) return;
                if (file.size > 800000) return alert("æª”æ¡ˆå¤ªå¤§ï¼ˆè«‹å°æ–¼ 800KBï¼‰ï¼Œä»¥å…é›²ç«¯åŒæ­¥å¤±æ•—ã€‚");
                const reader = new FileReader();
                reader.onload = (f) => {
                    if (type === 'pdf') this.pdfFiles.unshift({ name: file.name, data: f.target.result });
                    this.syncToCloud();
                };
                reader.readAsDataURL(file);
            },
            viewPdf(base64Data) { fetch(base64Data).then(res => res.blob()).then(blob => { window.open(URL.createObjectURL(blob), '_blank'); }); },
            deleteFile(idx, type) { if (type === 'pdf') this.pdfFiles.splice(idx, 1); this.syncToCloud(); },

            // == è¨˜å¸³ ==
            convertFX(f) { if (f === 'jpy' && this.fx.jpy) this.fx.hkd = parseFloat((this.fx.jpy * this.exchangeRate).toFixed(2)); else if (f === 'hkd' && this.fx.hkd) this.fx.jpy = parseFloat((this.fx.hkd / this.exchangeRate).toFixed(0)); else { this.fx.jpy = null; this.fx.hkd = null; } },
            addMember() { if(this.newMember && !this.members.includes(this.newMember)) { this.members.push(this.newMember); this.newMember = ''; this.syncToCloud(); } },
            removeMember(m) { this.members = this.members.filter(x => x !== m); this.syncToCloud(); },
            addExp() { if(this.newExp.amount && this.newExp.item && this.newExp.payer) { this.expenses.unshift({id: Date.now(), ...this.newExp}); this.syncToCloud(); this.newExp.item = ''; this.newExp.amount = null; } }
        },
        mounted() {
            const p = new URLSearchParams(window.location.search);
            if (this.tripId) {
                this.tripName = p.get('name'); this.startDate = p.get('start'); this.endDate = p.get('end');
                
                // è§¸ç™¼å¤©æ°£ç²å–
                this.fetchWeather();

                if(this.startDate && this.endDate) {
                    let s = new Date(this.startDate), e = new Date(this.endDate);
                    const ws = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
                    for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)) {
                        this.travelDays.push({date: d.toLocaleDateString('sv'), dayNum: d.getDate(), weekday: ws[d.getDay()]});
                    }
                    this.selectedDate = this.travelDays[0]?.date;
                }

                // å¯¦æ™‚åŒæ­¥
                db.collection('tabi_sync_v14').doc(this.tripId).onSnapshot(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        this.itineraries = d.itineraries || {}; this.flights = d.flights || []; this.hotels = d.hotels || [];
                        this.packingList = d.packingList || []; this.medicineList = d.medicineList || []; this.pdfFiles = d.pdfFiles || [];
                        this.members = d.members || ['æˆ‘', 'æ—…ä¼´A']; this.expenses = d.expenses || [];
                        
                        // è‹¥åœ¨åœ°åœ–é ï¼Œæœ‰è³‡æ–™æ›´æ–°æ™‚é‡ç•«
                        if(this.activeTab === 'map') this.updateMapMarkers();
                    }
                });
            }
            fetch('https://api.exchangerate-api.com/v4/latest/JPY').then(r => r.json()).then(d => this.exchangeRate = d.rates.HKD);
        }
    }).mount('#app');
</script>
</body>
</html>